<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin</title>
</head>
<body>
    <!-- 1) Identity widget (for login + invite handling) -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
        (function () {
            if (!window.netlifyIdentity) return;
            const m = location.hash && location.hash.match(/invite_token=([^&]+)/);
            if (m) {
                window.netlifyIdentity.acceptInvite(m[1], true)
                    .then(() => window.netlifyIdentity.open('login'))
                    .catch(() => window.netlifyIdentity.open('login'));
            }
            window.netlifyIdentity.on('login', () => location.replace('/admin/'));
        })();
    </script>

    <!-- 2) Manual init must be defined BEFORE Decap CMS is loaded -->
    <script>
      window.CMS_MANUAL_INIT = true;
      window.CMS_CONFIG = {
        backend: { name: "git-gateway", branch: "main" },
        site_url: "https://underworld-db.netlify.app",
        display_url: "https://underworld-db.netlify.app",
        media_folder: "admin/media",
        public_folder: "/admin/media",
        collections: [
          {
            name: "gamedata",
            label: "Game Data",
            label_singular: "Row",
            folder: "cms/GameData",
            create: false,
            format: "json",
            extension: "json",
            slug: "{{Id}}",
            editor: { preview: false },
            fields: [
              { label: "Id", name: "Id", widget: "string", default: "Global", pattern: ["^Global$", "Must be Global"] },
              { label: "Version", name: "Version", widget: "string" },
              { label: "LastPatchDate (YYYY-MM-DD)", name: "LastPatchDate", widget: "string", pattern: ["^\\d{4}-\\d{2}-\\d{2}$","Use YYYY-MM-DD"] },
              { label: "BuildType", name: "BuildType", widget: "select", options: ["Testing","Release","Live"], default: "Testing" }
            ]
          },
          {
            name: "balancedata",
            label: "Balance Data",
            label_singular: "Row",
            folder: "cms/BalanceData",
            create: false,
            format: "json",
            extension: "json",
            slug: "{{Id}}",
            editor: { preview: false },
            fields: [
              { label: "Id", name: "Id", widget: "string", default: "Global", pattern: ["^Global$", "Must be Global"] },
              { label: "GlobalExpGainModifier", name: "GlobalExpGainModifier", widget: "number", value_type: "float", min: 0, step: 0.01, default: 1.0 },
              { label: "GlobalDamageCausedModifier", name: "GlobalDamageCausedModifier", widget: "number", value_type: "float", min: 0, step: 0.01, default: 1.0 }
            ]
          }
        ]
      };
    </script>

    <!-- 3) Load Decap CMS and initialize from inline config -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"
            onload="CMS.init({ config: window.CMS_CONFIG });">
    </script>
</body>
</html>
